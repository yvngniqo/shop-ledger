<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <!-- Chosen Palette: "Ledger Green & Neutral Gray" -->
    <!-- Application Structure Plan: "A multi-screen SPA layout controlled by a bottom navigation bar, mimicking a native mobile app. The three screens (Ledger, Summary, Shopping List) provide focused views for each core task. This architecture is ideal for mobile usability, preventing clutter and making navigation intuitive. JavaScript will manage the visibility of each screen, showing only the active one." -->
    <!-- Visualization & Content Choices: "The Ledger screen uses a structured HTML table for data entry and display. The Summary screen uses simple, bold text to present key performance indicators. The Shopping List screen uses a dynamic list. This separation of concerns into different 'screens' simplifies the user experience on smaller devices and aligns with modern mobile UI patterns." -->
    <!-- CONFIRMATION: NO SVG graphics used. NO Mermaid JS used. -->
    <title>Multi-Screen Digital Ledger</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700&display=swap" rel="stylesheet">
    <style>
        body {
            font-family: 'Inter', sans-serif;
            background-color: #f7fafc;
        }
        #ledger-table thead {
            position: sticky;
            top: 0;
            z-index: 10;
        }
        #ledger-table input[type="number"], #ledger-table input[type="date"], #ledger-table select {
            text-align: right;
            padding: 0.5rem;
            border: 1px solid #cbd5e1;
            border-radius: 0.375rem;
            width: 100%;
            min-width: 100px;
            background-color: #fff;
            transition: border-color 0.2s;
        }
        #ledger-table input:focus, #ledger-table select:focus {
            outline: 2px solid transparent;
            outline-offset: 2px;
            border-color: #4f46e5;
        }
        #ledger-table input[type="date"], #ledger-table select {
             text-align: left;
        }
        .table-cell {
            padding: 0.5rem;
            vertical-align: middle;
            white-space: nowrap;
            border: 1px solid #e5e7eb;
        }
        .historical-row:nth-child(even) {
            background-color: #f8fafc;
        }
        .historical-row:hover {
            background-color: #f1f5f9;
        }
        #toast {
            position: fixed;
            bottom: 80px; /* Adjusted for nav bar */
            left: 50%;
            transform: translateX(-50%);
            padding: 10px 20px;
            border-radius: 8px;
            color: white;
            z-index: 100;
            opacity: 0;
            transition: opacity 0.5s;
        }
        .nav-btn.active {
            color: #4f46e5;
        }
    </style>
</head>
<body class="text-gray-800 pb-20">

    <div class="container mx-auto p-4 sm:p-6">
        <header class="text-center mb-6">
            <h1 id="header-title" class="text-3xl sm:text-4xl font-bold text-gray-900">Digital Shop Ledger</h1>
            <div class="flex justify-center items-center space-x-4 mt-4">
                 <button id="copy-link-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors flex items-center space-x-2">
                    <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M8.684 13.342C8.886 12.938 9 12.482 9 12s-.114-.938-.316-1.342m0 2.684a3 3 0 110-2.684m0 2.684l6.632 3.316m-6.632-6l6.632-3.316m0 0a3 3 0 105.367-2.684 3 3 0 00-5.367 2.684zm0 9.316a3 3 0 105.367 2.684 3 3 0 00-5.367-2.684z" /></svg>
                    <span>Share App</span>
                </button>
                <div class="text-xs text-gray-500">
                    <p>User ID: <span id="userId" class="font-mono bg-gray-200 p-1 rounded">Loading...</span></p>
                </div>
            </div>
        </header>

        <!-- Screen Containers -->
        <main>
            <!-- Ledger Screen -->
            <div id="ledger-screen" class="screen">
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="overflow-x-auto">
                        <table id="ledger-table" class="min-w-full w-full border-collapse border border-gray-300">
                            <thead class="bg-gray-100">
                                <tr>
                                    <th rowspan="2" class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Date</th>
                                    <th rowspan="2" class="table-cell text-left text-xs font-semibold text-gray-600 uppercase tracking-wider">Worker</th>
                                    <th colspan="2" class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">M-Pesa</th>
                                    <th colspan="2" class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Credit (Cards)</th>
                                    <th colspan="2" class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Shop</th>
                                    <th rowspan="2" class="table-cell text-right text-xs font-semibold text-gray-600 uppercase tracking-wider">Daily Total</th>
                                    <th rowspan="2" class="table-cell text-center text-xs font-semibold text-gray-600 uppercase tracking-wider">Actions</th>
                                </tr>
                                <tr>
                                    <th class="table-cell text-right text-xs font-semibold text-gray-500">Float</th>
                                    <th class="table-cell text-right text-xs font-semibold text-gray-500">Cash</th>
                                    <th class="table-cell text-right text-xs font-semibold text-gray-500">Cards</th>
                                    <th class="table-cell text-right text-xs font-semibold text-gray-500">Cash</th>
                                    <th class="table-cell text-right text-xs font-semibold text-gray-500">Cash</th>
                                    <th class="table-cell text-right text-xs font-semibold text-gray-500">Till</th>
                                </tr>
                            </thead>
                            <tbody id="ledger-body" class="bg-white divide-y divide-gray-200"></tbody>
                        </table>
                    </div>
                </div>
            </div>

            <!-- Summary Screen -->
            <div id="summary-screen" class="screen hidden">
                <div class="bg-white p-6 rounded-xl shadow-lg space-y-6">
                    <div>
                        <p class="text-lg text-gray-500">Today's Total Sales</p>
                        <p id="summary-today" class="text-4xl font-bold text-green-600">KSh 0</p>
                    </div>
                    <div>
                        <p class="text-lg text-gray-500">This Week's Total Sales</p>
                        <p id="summary-week" class="text-4xl font-bold text-blue-600">KSh 0</p>
                    </div>
                    <div>
                        <p class="text-lg text-gray-500">This Month's Total Sales</p>
                        <p id="summary-month" class="text-4xl font-bold text-indigo-600">KSh 0</p>
                    </div>
                </div>
            </div>

            <!-- Shopping List Screen -->
            <div id="shopping-list-screen" class="screen hidden">
                <div class="bg-white p-4 sm:p-6 rounded-xl shadow-lg">
                    <div class="flex space-x-2">
                        <input type="text" id="new-item-name" placeholder="e.g., Safaricom 100 cards" class="flex-grow p-2 border border-gray-300 rounded-lg">
                        <button id="add-item-btn" class="bg-blue-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-blue-700 transition-colors">Add</button>
                    </div>
                    <ul id="shopping-list" class="mt-4 space-y-2 max-h-[60vh] overflow-y-auto"></ul>
                    <p id="no-items-message" class="text-center text-gray-500 py-8">List is empty.</p>
                </div>
            </div>
        </main>
        
        <!-- Bottom Navigation -->
        <nav class="fixed bottom-0 left-0 right-0 bg-white border-t shadow-md flex justify-around">
            <button data-screen="ledger-screen" class="nav-btn flex-1 p-3 text-center text-gray-600 active">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M3 10h18M7 15h1m4 0h1m-7 4h12a3 3 0 003-3V8a3 3 0 00-3-3H6a3 3 0 00-3 3v8a3 3 0 003 3z" /></svg>
                <span class="text-xs">Ledger</span>
            </button>
            <button data-screen="summary-screen" class="nav-btn flex-1 p-3 text-center text-gray-600">
                 <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 19v-6a2 2 0 00-2-2H5a2 2 0 00-2 2v6a2 2 0 002 2h2a2 2 0 002-2zm0 0V9a2 2 0 012-2h2a2 2 0 012 2v10m-6 0a2 2 0 002 2h2a2 2 0 002-2m0 0V5a2 2 0 012-2h2a2 2 0 012 2v14a2 2 0 01-2 2h-2a2 2 0 01-2-2z" /></svg>
                <span class="text-xs">Summary</span>
            </button>
            <button data-screen="shopping-list-screen" class="nav-btn flex-1 p-3 text-center text-gray-600">
                <svg xmlns="http://www.w3.org/2000/svg" class="h-6 w-6 mx-auto" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M9 5H7a2 2 0 00-2 2v12a2 2 0 002 2h10a2 2 0 002-2V7a2 2 0 00-2-2h-2M9 5a2 2 0 002 2h2a2 2 0 002-2M9 5a2 2 0 012-2h2a2 2 0 012 2m-3 7h3m-3 4h3m-6-4h.01M9 16h.01" /></svg>
                <span class="text-xs">Shopping List</span>
            </button>
        </nav>

        <div id="toast"></div>
    </div>
    
    <script type="module">
        import { initializeApp } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-app.js";
        import { getAuth, signInAnonymously, onAuthStateChanged, setPersistence, browserLocalPersistence } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-auth.js";
        import { getFirestore, doc, getDoc, setDoc, collection, onSnapshot, query, deleteDoc, serverTimestamp, addDoc } from "https://www.gstatic.com/firebasejs/11.6.1/firebase-firestore.js";

        // IMPORTANT: Make sure you have replaced this with your own Firebase config on GitHub!
        const firebaseConfig = {
  apiKey: "AIzaSyACnJYn5dc89ZDfpFPpDwboN-DfRDJLbe4",
  authDomain: "my-shop-ledger.firebaseapp.com",
  projectId: "my-shop-ledger",
  storageBucket: "my-shop-ledger.firebasestorage.app",
  messagingSenderId: "701734588184",
  appId: "1:701734588184:web:6e7ffca1af9a8843e9986d"
};
        
        const appId = 'digital-shop-ledger';
        
        let db, auth, userId, currentWorkerName;
        let ledgerUnsubscribe = null;
        let shoppingListUnsubscribe = null;
        let editingRowId = null;
        
        const headerTitle = document.getElementById('header-title');
        const screens = document.querySelectorAll('.screen');
        const navButtons = document.querySelectorAll('.nav-btn');
        const ledgerBody = document.getElementById('ledger-body');
        const userIdEl = document.getElementById('userId');
        const copyLinkBtn = document.getElementById('copy-link-btn');
        const toastEl = document.getElementById('toast');
        const summaryTodayEl = document.getElementById('summary-today');
        const summaryWeekEl = document.getElementById('summary-week');
        const summaryMonthEl = document.getElementById('summary-month');
        const newItemNameInput = document.getElementById('new-item-name');
        const addItemBtn = document.getElementById('add-item-btn');
        const shoppingListEl = document.getElementById('shopping-list');
        const noItemsMessage = document.getElementById('no-items-message');

        function getLedgerCollectionPath() { return `artifacts/${appId}/public/data/ledger`; }
        function getShoppingListCollectionPath() { return `artifacts/${appId}/public/data/shoppingList`; }

        function formatCurrency(value) {
            const number = value || 0;
            const formattedNumber = number.toLocaleString('en-US', { minimumFractionDigits: 0, maximumFractionDigits: 0 });
            return `KSh ${formattedNumber}`;
        }
        
        function toISODate(date) { return date.toISOString().split('T')[0]; }

        function renderTable(records) {
            ledgerBody.innerHTML = ''; 
            
            const newEntryRow = document.createElement('tr');
            newEntryRow.id = 'new-entry-row';
            newEntryRow.className = 'bg-green-50';
            renderEditableRow(newEntryRow, {});
            ledgerBody.appendChild(newEntryRow);

            if (records.length === 0) {
                const noRecordsRow = document.createElement('tr');
                noRecordsRow.innerHTML = `<td colspan="10" class="text-center text-gray-500 py-12">No records found. Add your first entry above!</td>`;
                ledgerBody.appendChild(noRecordsRow);
            } else {
                records.forEach(record => {
                    const row = document.createElement('tr');
                    row.className = 'historical-row';
                    row.dataset.id = record.id;
                    if (editingRowId === record.id) { renderEditableRow(row, record); } 
                    else { renderReadOnlyRow(row, record); }
                    ledgerBody.appendChild(row);
                });
            }
            attachEventListeners();
        }
        
        function renderReadOnlyRow(rowEl, record) {
            const recordDate = record.date.toDate ? record.date.toDate() : new Date(record.date);
            const total = (record.mpesaFloat || 0) + (record.mpesaCash || 0) + (record.creditCards || 0) + (record.creditCash || 0) + (record.shopCash || 0) + (record.shopTill || 0);
            rowEl.innerHTML = `
                <td class="table-cell font-medium text-gray-900">${recordDate.toLocaleDateString('en-GB')}</td>
                <td class="table-cell font-semibold text-gray-700">${record.worker || 'N/A'}</td>
                <td class="table-cell text-sm text-right">${formatCurrency(record.mpesaFloat)}</td>
                <td class="table-cell text-sm text-right">${formatCurrency(record.mpesaCash)}</td>
                <td class="table-cell text-sm text-right">${formatCurrency(record.creditCards)}</td>
                <td class="table-cell text-sm text-right">${formatCurrency(record.creditCash)}</td>
                <td class="table-cell text-sm text-right">${formatCurrency(record.shopCash)}</td>
                <td class="table-cell text-sm text-right">${formatCurrency(record.shopTill)}</td>
                <td class="table-cell text-right font-bold text-indigo-700 text-lg">${formatCurrency(total)}</td>
                <td class="table-cell text-center">
                    <button class="edit-btn p-2 text-blue-600 hover:text-blue-800 rounded-full hover:bg-blue-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" fill="none" viewBox="0 0 24 24" stroke="currentColor" stroke-width="2"><path stroke-linecap="round" stroke-linejoin="round" d="M15.232 5.232l3.536 3.536m-2.036-5.036a2.5 2.5 0 113.536 3.536L6.5 21.036H3v-3.536L16.732 3.732z" /></svg>
                    </button>
                    <button class="delete-btn p-2 text-red-500 hover:text-red-700 rounded-full hover:bg-red-100 transition-colors">
                        <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm4 0a1 1 0 012 0v6a1 1 0 11-2 0V8z" clip-rule="evenodd" /></svg>
                    </button>
                </td>
            `;
        }

        function renderEditableRow(rowEl, record) {
            const isNew = !record.id;
            const idPrefix = isNew ? 'new' : `edit-${record.id}`;
            const recordDate = record.date?.toDate ? record.date.toDate() : new Date();
            
            rowEl.innerHTML = `
                <td class="table-cell"><input type="date" id="${idPrefix}-date" value="${toISODate(recordDate)}"></td>
                <td class="table-cell">
                    <select id="${idPrefix}-worker">
                        <option value="Tyson" ${record.worker === 'Tyson' ? 'selected' : ''}>Tyson</option>
                        <option value="Phelsy" ${record.worker === 'Phelsy' ? 'selected' : ''}>Phelsy</option>
                        <option value="Other" ${!['Tyson', 'Phelsy'].includes(record.worker) ? 'selected' : ''}>Other</option>
                    </select>
                </td>
                <td class="table-cell"><input type="number" id="${idPrefix}-mpesa-float" placeholder="0" value="${record.mpesaFloat || ''}"></td>
                <td class="table-cell"><input type="number" id="${idPrefix}-mpesa-cash" placeholder="0" value="${record.mpesaCash || ''}"></td>
                <td class="table-cell"><input type="number" id="${idPrefix}-credit-cards" placeholder="0" value="${record.creditCards || ''}"></td>
                <td class="table-cell"><input type="number" id="${idPrefix}-credit-cash" placeholder="0" value="${record.creditCash || ''}"></td>
                <td class="table-cell"><input type="number" id="${idPrefix}-shop-cash" placeholder="0" value="${record.shopCash || ''}"></td>
                <td class="table-cell"><input type="number" id="${idPrefix}-shop-till" placeholder="0" value="${record.shopTill || ''}"></td>
                <td id="${idPrefix}-total" class="table-cell text-right font-bold text-gray-700 text-lg">--</td>
                <td class="table-cell text-center">
                    <button class="save-btn bg-green-600 text-white font-bold py-2 px-4 rounded-lg hover:bg-green-700 transition-colors">
                        ${isNew ? 'Save' : 'Update'}
                    </button>
                    ${!isNew ? `<button class="cancel-edit-btn mt-2 text-xs text-gray-500 hover:underline">Cancel</button>` : ''}
                </td>
            `;
            updateLiveTotal(rowEl, idPrefix);
        }
        
        function updateLiveTotal(rowEl, idPrefix) {
            const getVal = (selector) => {
                const el = rowEl.querySelector(selector);
                return el ? (parseFloat(el.value) || 0) : 0;
            };
            const total = getVal(`#${idPrefix}-mpesa-float`) + getVal(`#${idPrefix}-mpesa-cash`) + getVal(`#${idPrefix}-credit-cards`) + getVal(`#${idPrefix}-credit-cash`) + getVal(`#${idPrefix}-shop-cash`) + getVal(`#${idPrefix}-shop-till`);
            const totalEl = rowEl.querySelector(`#${idPrefix}-total`);
            if (totalEl) {
                totalEl.textContent = formatCurrency(total);
            }
        }

        async function handleSave(rowEl, idPrefix, recordId) {
            const getVal = (selector) => {
                const el = rowEl.querySelector(selector);
                return el ? (parseFloat(el.value) || 0) : 0;
            };
            const getSelectVal = (selector) => {
                const el = rowEl.querySelector(selector);
                return el ? el.value : '';
            }
            const dateEl = rowEl.querySelector(`#${idPrefix}-date`);
            const dateVal = dateEl ? dateEl.value : '';

            if (!dateVal) {
                showToast("Please select a date.", "error");
                return;
            }

            let createdAt = serverTimestamp();
            if (recordId) {
                try {
                    const docRef = doc(db, getLedgerCollectionPath(), recordId);
                    const docSnap = await getDoc(docRef);
                    if (docSnap.exists() && docSnap.data().createdAt) {
                        createdAt = docSnap.data().createdAt;
                    }
                } catch(e) { console.error("Could not retrieve original creation date.", e); }
            }

            const recordData = {
                date: new Date(dateVal),
                worker: getSelectVal(`#${idPrefix}-worker`),
                mpesaFloat: getVal(`#${idPrefix}-mpesa-float`),
                mpesaCash: getVal(`#${idPrefix}-mpesa-cash`),
                creditCards: getVal(`#${idPrefix}-credit-cards`),
                creditCash: getVal(`#${idPrefix}-credit-cash`),
                shopCash: getVal(`#${idPrefix}-shop-cash`),
                shopTill: getVal(`#${idPrefix}-shop-till`),
                createdAt: createdAt
            };
            
            try {
                const docId = recordId || recordData.date.toISOString().split('T')[0] + '-' + Date.now();
                const docRef = doc(db, getLedgerCollectionPath(), docId);
                await setDoc(docRef, recordData, { merge: true });
                showToast(recordId ? "Record updated!" : "Record saved!", "success");
                if (editingRowId) {
                    editingRowId = null;
                    listenToLedger();
                } else {
                    const newEntryRow = document.getElementById('new-entry-row');
                    if (newEntryRow) {
                        newEntryRow.querySelectorAll('input[type="number"]').forEach(input => input.value = '');
                        updateLiveTotal(newEntryRow, 'new');
                    }
                }
            } catch (error) {
                console.error("Error saving record:", error);
                showToast("Error saving record.", "error");
            }
        }

        async function handleDelete(id) {
            if (!confirm("Are you sure you want to delete this record?")) return;
            try {
                await deleteDoc(doc(db, getLedgerCollectionPath(), id));
                showToast("Record deleted.", "success");
            } catch (error) {
                console.error("Error deleting record: ", error);
                showToast("Error deleting record.", "error");
            }
        }
        
        function updateSummaryBox(records) {
            const now = new Date();
            const startOfToday = new Date(now.getFullYear(), now.getMonth(), now.getDate());
            const startOfWeek = new Date(startOfToday);
            startOfWeek.setDate(startOfWeek.getDate() - startOfWeek.getDay());
            const startOfMonth = new Date(now.getFullYear(), now.getMonth(), 1);

            let todayTotal = 0, weekTotal = 0, monthTotal = 0;

            records.forEach(record => {
                const recordDate = record.date.toDate ? record.date.toDate() : new Date(record.date);
                const total = (record.mpesaFloat || 0) + (record.mpesaCash || 0) + (record.creditCards || 0) + (record.creditCash || 0) + (record.shopCash || 0) + (record.shopTill || 0);
                
                if (recordDate >= startOfToday) { todayTotal += total; }
                if (recordDate >= startOfWeek) { weekTotal += total; }
                if (recordDate >= startOfMonth) { monthTotal += total; }
            });

            summaryTodayEl.textContent = formatCurrency(todayTotal);
            summaryWeekEl.textContent = formatCurrency(weekTotal);
            summaryMonthEl.textContent = formatCurrency(monthTotal);
        }

        function listenToLedger() {
            if (!userId || !db) return;
            const q = query(collection(db, getLedgerCollectionPath()));
            
            ledgerUnsubscribe = onSnapshot(q, (snapshot) => {
                const records = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                updateSummaryBox(records);
                records.sort((a, b) => (b.date.toDate ? b.date.toDate() : new Date(b.date)) - (a.date.toDate ? a.date.toDate() : new Date(a.date)));
                renderTable(records);
            }, (error) => { console.error("Error listening to ledger: ", error); });
        }

        function attachEventListeners() {
            ledgerBody.querySelectorAll('input[type="number"]').forEach(input => {
                input.addEventListener('input', (e) => {
                    const row = e.target.closest('tr');
                    const idPrefix = e.target.id.substring(0, e.target.id.lastIndexOf('-'));
                    updateLiveTotal(row, idPrefix);
                });
            });

            ledgerBody.addEventListener('click', (e) => {
                const row = e.target.closest('tr');
                if (!row) return;

                if (e.target.closest('.save-btn')) {
                    const idPrefix = row.querySelector('input, select').id.substring(0, row.querySelector('input, select').id.lastIndexOf('-'));
                    handleSave(row, idPrefix, row.dataset.id);
                }
                if (e.target.closest('.delete-btn')) { handleDelete(row.dataset.id); }
                if (e.target.closest('.edit-btn')) {
                    editingRowId = row.dataset.id;
                    listenToLedger();
                }
                if (e.target.closest('.cancel-edit-btn')) {
                    editingRowId = null;
                    listenToLedger();
                }
            });
        }
        
        function showToast(message, type = "success") {
            toastEl.textContent = message;
            toastEl.className = type === 'success' ? 'bg-green-600' : 'bg-red-600';
            toastEl.style.opacity = 1;
            setTimeout(() => { toastEl.style.opacity = 0; }, 3000);
        }

        function renderShoppingList(items) {
            shoppingListEl.innerHTML = '';
            if (items.length === 0) {
                noItemsMessage.style.display = 'block';
            } else {
                noItemsMessage.style.display = 'none';
                items.forEach(item => {
                    const li = document.createElement('li');
                    li.className = 'flex justify-between items-center p-2 bg-gray-50 rounded-lg';
                    li.innerHTML = `
                        <span class="text-gray-800">${item.itemName}</span>
                        <button data-id="${item.id}" class="remove-item-btn p-1 text-green-500 hover:text-green-700 rounded-full hover:bg-green-100">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor"><path fill-rule="evenodd" d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z" clip-rule="evenodd" /></svg>
                        </button>
                    `;
                    shoppingListEl.appendChild(li);
                });
            }
        }

        async function handleAddItem() {
            const itemName = newItemNameInput.value.trim();
            if (!itemName) {
                showToast("Please enter an item name.", "error");
                return;
            }
            try {
                await addDoc(collection(db, getShoppingListCollectionPath()), {
                    itemName,
                    addedBy: currentWorkerName || 'Unknown',
                    createdAt: serverTimestamp()
                });
                newItemNameInput.value = '';
            } catch (error) {
                console.error("Error adding item:", error);
                showToast("Could not add item.", "error");
            }
        }

        function listenToShoppingList() {
            if (!userId || !db) return;
            const q = query(collection(db, getShoppingListCollectionPath()));
            shoppingListUnsubscribe = onSnapshot(q, (snapshot) => {
                const items = snapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));
                items.sort((a, b) => a.createdAt - b.createdAt);
                renderShoppingList(items);
            }, (error) => { console.error("Error listening to shopping list:", error); });
        }

        function switchScreen(screenId) {
            screens.forEach(screen => {
                screen.classList.toggle('hidden', screen.id !== screenId);
            });
            navButtons.forEach(btn => {
                btn.classList.toggle('active', btn.dataset.screen === screenId);
            });
            
            if (screenId === 'ledger-screen') headerTitle.textContent = 'Digital Shop Ledger';
            if (screenId === 'summary-screen') headerTitle.textContent = 'Performance Summary';
            if (screenId === 'shopping-list-screen') headerTitle.textContent = 'Shopping List';
        }

        document.addEventListener('DOMContentLoaded', async () => {
            if (firebaseConfig.apiKey === "YOUR_API_KEY") {
                document.querySelector('main').innerHTML = `
                    <div class="bg-red-100 border-l-4 border-red-500 text-red-700 p-8 rounded-xl shadow-lg" role="alert">
                        <p class="font-bold text-2xl mb-4">Configuration Error</p>
                        <p class="text-lg">The app is not connected to a database. You need to replace the placeholder Firebase keys in the code.</p>
                        <ol class="list-decimal list-inside mt-4 space-y-2">
                            <li>Go to your project settings on the Firebase website.</li>
                            <li>Find and copy your <strong>firebaseConfig</strong> keys.</li>
                            <li>Paste them into the <code>index.html</code> file on GitHub to replace the placeholder.</li>
                        </ol>
                    </div>
                `;
                return;
            }

            try {
                const app = initializeApp(firebaseConfig);
                db = getFirestore(app);
                auth = getAuth(app);
                await setPersistence(auth, browserLocalPersistence);

                onAuthStateChanged(auth, async (user) => {
                    if (user) {
                        userId = user.uid;
                        userIdEl.textContent = userId;
                        if (ledgerUnsubscribe) ledgerUnsubscribe();
                        if (shoppingListUnsubscribe) shoppingListUnsubscribe();
                        listenToLedger();
                        listenToShoppingList();
                    } else {
                        signInAnonymously(auth).catch((error) => {
                            console.error("Anonymous sign-in failed:", error);
                            userIdEl.textContent = "Connection Failed";
                            showToast("Error: Could not connect to the database.", "error");
                            ledgerBody.innerHTML = `<tr><td colspan="10" class="text-center text-red-500 p-8">
                                <strong>Connection Failed.</strong><br>
                                Please check your Firebase project settings.<br>
                                1. Go to Authentication -> Sign-in method.<br>
                                2. Make sure 'Anonymous' sign-in is enabled.
                            </td></tr>`;
                        });
                    }
                });

                copyLinkBtn.addEventListener('click', () => {
                    const url = window.location.href;
                    const textarea = document.createElement('textarea');
                    textarea.value = url;
                    document.body.appendChild(textarea);
                    textarea.select();
                    document.execCommand('copy');
                    document.body.removeChild(textarea);
                    showToast("App link copied to clipboard!");
                });
                
                addItemBtn.addEventListener('click', handleAddItem);
                newItemNameInput.addEventListener('keypress', (e) => {
                    if (e.key === 'Enter') {
                        handleAddItem();
                    }
                });
                
                shoppingListEl.addEventListener('click', async (e) => {
                    if (e.target.closest('.remove-item-btn')) {
                        const id = e.target.closest('.remove-item-btn').dataset.id;
                        try {
                            await deleteDoc(doc(db, getShoppingListCollectionPath(), id));
                            showToast("Item marked as done!", "success");
                        } catch (error) {
                            console.error("Error removing item:", error);
                            showToast("Could not remove item.", "error");
                        }
                    }
                });

                navButtons.forEach(btn => {
                    btn.addEventListener('click', () => {
                        switchScreen(btn.dataset.screen);
                    });
                });

            } catch (error) {
                console.error("Initialization error:", error);
            }
        });
    </script>
</body>
</html>
